trigger:
  branches:
    include:
    - '*'
  paths:
    include:
    - 'BasicWebApp/*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  solution: 'BasicWebApp/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

jobs:
  - job: build_and_test
    displayName: Build and Publish
    steps:
    - task: DotNetCoreCLI@2
      displayName: Restore Packages
      inputs:
        command: restore
        projects: ${{ variables.solution }}
        feedsToUse: select

    - task: DotNetCoreCLI@2
      displayName: Build Solution
      inputs:
        command: build
        projects: ${{ variables.solution }}
        configuration: $(buildConfiguration)

    - task: DotNetCoreCLI@2
      displayName: Publish Solution
      inputs:
        command: publish
        publishWebProjects: True
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: True

    - task: PublishPipelineArtifact@1
      displayName: Publish Artifacts
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)' 
        artifactName: BasicWebApp
  
  - deployment: 
    - task: AzureRmWebAppDeployment@4
      inputs:
        ConnectionType: 'AzureRM'
        azureSubscription: 'Azure Development Subscription'
        appType: 'webAppLinux'
        WebAppName: 'basic-web-app-dev'
        packageForLinux: '$(Build.ArtifactStagingDirectory)/**/*.zip'
        RuntimeStack: 'DOTNETCORE|6.0'